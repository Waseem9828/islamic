
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // A function to check if the user is an admin.
    function isAdmin() {
      // Check if the user has an admin role in Firestore.
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // Rules for deposit screenshots
    match /deposits/{userId}/{fileName} {
      // Allow write access if the user is the owner of the folder or is an admin.
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Allow read access if the user is the owner or an admin.
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }
    
    // Rules for result screenshots
    match /results/{matchId}/{userId}/{fileName} {
      // Allow a player to upload their result screenshot.
      allow write: if request.auth != null && request.auth.uid == userId;
      // Allow admin to read the result screenshots for verification.
      allow read: if isAdmin();
    }

    // Rules for user avatars
    match /avatars/{userId} {
      // Allow anyone to read avatars, as they are public profile pictures.
      allow read: if true;
      // Allow a user to write (create, update, delete) to their own avatar folder.
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Fallback rule to deny all other access.
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

    