/**
 * @fileoverview Firestore Security Rules for the Islamic Random Selector app.
 *
 * Core Philosophy:
 * This ruleset enforces a strict admin-controlled model for draws and draw results, with paid subscriptions required for users to access the results.
 * Access to draw results is determined by the presence of a `subscriptionId` on the `User` document.
 * Administrative privileges are granted based on user presence in the `/roles_admin/{adminId}` collection.
 *
 * Data Structure:
 * - `/users/{userId}`: Stores user profiles, including a `subscriptionId` for authorization.
 * - `/roles_admin/{adminId}`: List of admin user IDs. Existence grants admin privileges.
 * - `/draws/{drawId}`: Stores information about each draw.
 * - `/draws/{drawId}/draw_results/{drawResultId}`: Stores results for each draw.
 * - `/groups/{groupId}`: Stores group information (e.g., Gali, Disawar).
 * - `/users/{userId}/subscriptions/{subscriptionId}`: Stores user subscription information.
 * - `/subscription_tiers/{subscriptionTierId}`: Stores information about different subscription tiers.
 *
 * Key Security Decisions:
 * - Only admins can create, update, or delete draws and draw results.
 * - Only subscribed users can read draw results.
 * - Users can only manage their own profile and subscriptions.
 * - Listing all draw results is not permitted to avoid QAPs.
 * - Admin status is determined by presence in the `/roles_admin/{adminId}` collection.
 *
 * Denormalization for Authorization:
 * - The `User` document includes a `subscriptionId` field. This avoids needing to read the `Subscription` document to verify a user's subscription status.
 *   This pattern is called "Authorization Independence" and reduces the number of reads required to authorize a request.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource, based on the userId.
     * @param {string} userId - The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the resource.
     * @param {string} userId - The user ID to check against.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user has a valid subscription by verifying that the `subscriptionId` field exists on the user document.
     * @return {boolean} True if the user has a valid subscription, false otherwise.
     */
    function hasValidSubscription() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscriptionId != null;
    }

    /**
     * @description Rule for /users/{userId} documents.
     * @path /users/{userId}
     * @allow (create) User 'user123' with ID matching path can create their profile.
     * @deny (create) User 'user456' tries to create profile for 'user123'.
     * @allow (get) Any signed-in user can read any profile.
     * @deny (update) User 'user123' tries to change their ID.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /users/{userId} {
      allow get: if true;
      allow list: if false; // Listing all users is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // ID immutability
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for /roles_admin/{adminId} documents.
     * @path /roles_admin/{adminId}
     * @allow (create) Admin 'admin123' can create their role document.
     * @deny (delete) Non-admin cannot delete an admin role document.
     * @principle Only admins can manage the admin roles collection.
     */
    match /roles_admin/{adminId} {
      allow get: if isAdmin();
      allow list: if false; // Listing all admins is not permitted.
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }

    /**
     * @description Rule for /draws/{drawId} documents.
     * @path /draws/{drawId}
     * @allow (create) Admin 'admin123' can create a new draw.
     * @deny (delete) Non-admin cannot delete a draw.
     * @principle Only admins can manage draws.
     */
    match /draws/{drawId} {
      allow get: if true;
      allow list: if true; // Listing all draws is permitted.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rule for /draws/{drawId}/draw_results/{drawResultId} documents.
     * @path /draws/{drawId}/draw_results/{drawResultId}
     * @allow (create) Admin 'admin123' can create a new draw result.
     * @deny (get) Non-subscribed user cannot read draw results.
     * @principle Only admins can manage draw results, and only subscribed users can read them.
     */
    match /draws/{drawId}/draw_results/{drawResultId} {
      allow get: if hasValidSubscription() || isAdmin();
      allow list: if false; // Listing is disabled. This prevents QAPs. To enable, create a query-based rule instead.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rule for /groups/{groupId} documents.
     * @path /groups/{groupId}
     * @allow (get) Any signed-in user can read any group.
     * @deny (create) Non-admin cannot create a group.
     */
    match /groups/{groupId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rule for /users/{userId}/subscriptions/{subscriptionId} documents.
     * @path /users/{userId}/subscriptions/{subscriptionId}
     * @allow (create) User 'user123' can create their own subscription.
     * @deny (delete) Another user cannot delete 'user123's subscription.
     * @principle Enforces document ownership, allowing users to manage their own subscriptions.
     */
    match /users/{userId}/subscriptions/{subscriptionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for /subscription_tiers/{subscriptionTierId} documents.
     * @path /subscription_tiers/{subscriptionTierId}
     * @allow (get) Any signed-in user can read any subscription tier.
     * @deny (create) Non-admin user cannot create a subscription tier.
     */
    match /subscription_tiers/{subscriptionTierId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}