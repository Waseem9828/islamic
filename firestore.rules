
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      // Allow access if the user's UID is the designated admin UID.
      return request.auth.uid == 'Mh28D81npYYDfC3z8mslVIPFu5H3'; // <<<--- YOUR ADMIN UID HAS BEEN SET
    }

    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // SETTINGS
    match /settings/{doc} {
      // Any signed-in user can read settings (e.g., for payment info)
      allow get: if isSignedIn();
      // Only admins can change settings
      allow write: if isAdmin();
    }

    // USERS
    match /users/{userId} {
      // A user can read or write their own profile data. Admins can too.
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // WALLETS
    match /wallets/{userId} {
      // A user can read their own wallet, and admins can manage it.
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // DEPOSIT REQUESTS
    match /depositRequests/{requestId} {
      // Allow creation only if the user is signed in and the data is structured correctly.
      allow create: if isSignedIn() && isOwner(request.resource.data.userId)
                      && request.resource.data.keys().hasOnly(['userId', 'amount', 'transactionId', 'status', 'requestedAt'])
                      && request.resource.data.amount > 0
                      && request.resource.data.transactionId is string
                      && request.resource.data.transactionId.size() >= 12
                      && request.resource.data.status == 'pending';
      // Only admins can read or update (approve/reject) deposit requests.
      allow read, update: if isAdmin();
    }

    // WITHDRAWAL REQUESTS
    match /withdrawalRequests/{requestId} {
      // Allow creation if the user is the owner and data is valid.
       allow create: if isSignedIn()
                      && isOwner(request.resource.data.userId)
                      && request.resource.data.keys().hasOnly(['userId', 'amount', 'upiId', 'status', 'requestedAt'])
                      && request.resource.data.amount > 0
                      && request.resource.data.upiId.matches('^[\\w.-]+@[\\w.-]+$')
                      && request.resource.data.status == 'pending';
      // Admins can read and update (approve/reject) withdrawals.
      allow read, update: if isAdmin();
    }
    
    // TRANSACTIONS
    match /transactions/{transactionId} {
        // Users can read their own transaction history.
        allow read: if isSignedIn() && isOwner(resource.data.userId);
        // Only backend (Cloud Functions) can create transactions.
        allow write: if false;
    }
    
    // MATCHES
    match /matches/{matchId} {
      // Any signed-in user can read match details.
      allow read: if isSignedIn();
      // Allow signed-in users to update a match (e.g. for joining, leaving, setting ready status).
      // Creation is handled by the Cloud Function. Deletion is not allowed from client.
      allow update: if isSignedIn(); 
      allow create, delete: if false;
    }
  }
}
