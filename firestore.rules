
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==================================================
    // Helper Functions
    // ==================================================

    function isAdmin(role) {
      return role == 'worker' || role == 'super';
    }

    function isSuperAdmin(role) {
      return role == 'super';
    }

    function getAdminRole(uid) {
      return get(/databases/$(database)/documents/admins/$(uid)).data.role;
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // ==================================================
    // Admin Collection Rules (Part E)
    // ==================================================
    match /admins/{adminId} {
      // READ: Super Admins can read any admin doc. Workers can read their own.
      allow read: if isAuthenticated() && 
                    (isSuperAdmin(getAdminRole(request.auth.uid)) || isOwner(adminId));

      // CREATE: Only Super Admins can create new admins (handled by cloud function).
      allow create: if isAuthenticated() && isSuperAdmin(getAdminRole(request.auth.uid));

      // UPDATE: Only Super Admins can update admin docs (e.g., change status, role).
      // Workers CANNOT update their own wallet.
      allow update: if isAuthenticated() && isSuperAdmin(getAdminRole(request.auth.uid));

      // DELETE: Only Super Admins can delete.
      allow delete: if isAuthenticated() && isSuperAdmin(getAdminRole(request.auth.uid));
    }

    match /adminWalletHistory/{historyId} {
      // Only Super Admins can read or write history.
      allow read, write: if isAuthenticated() && isSuperAdmin(getAdminRole(request.auth.uid));
    }

    match /adminActivity/{activityId} {
       // Super admins can read all activity. Worker admins can read their own.
       allow read: if isAuthenticated() && 
                    (isSuperAdmin(getAdminRole(request.auth.uid)) || get(/databases/$(database)/documents/adminActivity/$(activityId)).data.adminId == request.auth.uid);
      // Writes are handled by secure cloud functions.
      allow write: if false; 
    }

    // ==================================================
    // Transaction Collection Rules (Part E)
    // ==================================================
    match /transactions_deposit/{depositId} {
        // Admins can read all, users can read their own.
        allow read: if isAuthenticated() && 
                      (isAdmin(getAdminRole(request.auth.uid)) || get(/databases/$(database)/documents/transactions_deposit/$(depositId)).data.userId == request.auth.uid);
        
        // Users can create their own deposit requests.
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

        // Updates (approve/reject) are handled by a secure cloud function.
        allow update, delete: if false;
    }

    match /transactions_withdraw/{withdrawId} {
        // Admins can read all, users can read their own.
        allow read: if isAuthenticated() && 
                      (isAdmin(getAdminRole(request.auth.uid)) || get(/databases/$(database)/documents/transactions_withdraw/$(withdrawId)).data.userId == request.auth.uid);
        
        // Users can create their own withdrawal requests.
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

        // Updates (completing/rejecting) are handled by a secure cloud function.
        allow update, delete: if false;
    }

    // ==================================================
    // Existing User and Wallet Rules (Assumed)
    // ==================================================

    match /users/{userId} {
      // Users can read/write their own data.
      allow read, write: if isOwner(userId);
      // Super admins can also read any user doc for support.
      allow read: if isAuthenticated() && isSuperAdmin(getAdminRole(request.auth.uid));
    }

    match /wallets/{userId} {
        // Users can only read their own wallet.
        allow read: if isOwner(userId);
        // Wallet updates should ONLY be done via secure cloud functions.
        allow write: if false;
    }
    
    // Rules for user-specific subcollections like transactions.
    match /users/{userId}/transactions/{transactionId} {
        allow read, list: if isOwner(userId);
        allow create, update, delete: if false; // All transactions created by server functions
    }

    // Fallback rule: deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
